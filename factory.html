<!DOCTYPE html>
<html>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<head>
	
	<title> מפעל </title>
	
	</head>
	<script src="script.js"></script>
	<link href="elements.css" rel="stylesheet">
<!-- 	<link href="slider.css" rel="stylesheet">
	<script src="slider.js"></script> -->
	<body>
		<img id="Image-Maps-Com-image-maps-2017-02-27-133629" src="http://www.image-maps.com/m/private/0/kc8s5abvl71v1vpcn556o5smb1_factory.png" border="0" width="881" height="496" orgWidth="881" orgHeight="496" usemap="#image-maps-2017-02-27-133629" alt="" />
		<map name="image-maps-2017-02-27-133629" id="ImageMapsCom-image-maps-2017-02-27-133629">
		<area id="goBack" alt="" title="" href="main.html" shape="rect" coords="0,467,881,496" style="outline:none;" target="_self"     />
		<area id="factorySlider" onclick="div_show('abc')" alt="" title="" href="#" shape="rect" coords="69,69,302,218" style="outline:none;" target="_self"     />
		<area id="factoryCTopLeft" onclick="emptyC()" alt="" title="" href="#" shape="rect" coords="393,35,518,160" style="outline:none;" target="_self"     />
		<area id="factoryCTopMid" onclick="div_show('mid')" alt="" title="" href="#" shape="rect" coords="520,38,634,163" style="outline:none;" target="_self"     />
		<area id="factoryCTopRight" onclick="emptyC()" alt="" title="" href="#" shape="rect" coords="765,39,858,130" style="outline:none;" target="_self"     />
		<area id="factoryCBottom" onclick="emptyC()" alt="" title="" href="#" shape="rect" coords="741,278,851,395" style="outline:none;" target="_self"     />
		<area id="factoryBin" onclick="garbage()" alt="" title="" href="#" shape="poly" coords="223,385,229,441,293,465,340,441,347,387,276,370" style="outline:none;" target="_self"/>
		<area id="factoryTrash" onclick="garbage()" alt="" title="" href="#" shape="poly" coords="518,346,477,325,445,330,418,343,419,372,393,400,388,431,404,458,439,445,470,455,505,448" style="outline:none;" target="_self"     />
		<area id="factoryComp" onclick="div_show('abc2')" alt="" title="" href="#" shape="poly" coords="321,295,323,220,11,220,11,291,61,293,65,262,111,255,147,266,148,291" style="outline:none;" target="_self"/>
		</map>

		<div id="abc">
		<!-- Popup Div Starts Here -->
		<div id="111" style="position:absolute;left:50%;top:5%;margin-left:-202px;direction:ltr;">
		<!-- Contact Us Form -->
		<div id="slide" style="padding:5px 5px;border:2px solid gray;border-radius:10px;background-color:#fff">
		<img id="close" src="imgs/x.png" style="width:30px" onclick ="div_hide('abc')">
			<div>
				<div id="puzzle"></div>
				<div id="clicks">0</div>
				<input type="checkbox" id="displayHelp" value="" />עזרה 
				<button id="randomize">ערבב</button>
			</div>
		</div>
		</div>
		<!-- Popup Div Ends Here -->
		</div>
		
		<div id="abc2" class="abc2">
		<!-- Popup Div Starts Here -->
		<div id="popupContact2" class="popupContact2">
		<!-- Contact Us Form -->
		<div id="tofes2" class="tofes2">
		<img id="close2" src="imgs/x.png" style="width:30px" onclick ="div_hide('abc2')">
			<img src="imgs/factoryComp.jpg" width="500px">
		</div>
		</div>
		<!-- Popup Div Ends Here -->
		</div>
		
		<div id="mid" class="abc2">
		<!-- Popup Div Starts Here -->
		<div id="popupMid" class="popupContact2">
		<!-- Contact Us Form -->
		<div id="tofesMid" class="tofes2">
		<img id="closeBtn" class="close2" src="imgs/x.png" style="width:30px" onclick ="div_hide('mid')">
		<div id="factMidClose">
			<h2>הזן קוד לפתיחת הארון</h2>
			<hr>
			<input id="factMid" type="password" style="color:black;margin-right:20%;width:50%;background-color:white;border:1px solid lightgray">
			<hr>
			<a href="#" onclick="factMidClick()" id="submit">פתח</a>
			
		</div>
		<div id="factOpen" style="display:none;">
			<img src="imgs/menus.png" width="450px">
		</div>
		</div>
		</div>
		<!-- Popup Div Ends Here -->
		</div>
		
	</body>
	
	<script>
	var imagePart = (function() {
    return function(x, y, rows, columns, img, special) {
        var _x = x, _y = y;
        var _posX = x, _posY = y;
        var _offsetX, _offsetY;
        var _rows = rows, _columns = columns;
        var _special = special;
        var _img = img;

        this.changePosition = function(posX, posY) {
            _posX = posX;
            _posY = posY;
            this.refresh();
        }

        this.posX = function() { return _posX; }
        this.posY = function() { return _posY; }
        this.special = function() { return _special; }

        this.id = function () {
            return '#' + _posY + _posX;
        }

        this.onDatPlace = function() {
            return _posX == _x && _posY == _y;
        }

        this.refresh = function() {
            var ctx = $(this.id())[0].getContext('2d');
            _offsetX = -_x*(_img.width/_columns);
            _offsetY = -_y*(_img.height/_rows);
            if(!_special) {
                ctx.drawImage(_img, _offsetX, _offsetY);
                if(displayHelp) {
                    ctx.font = "12pt Arial";
                    ctx.fillStyle = "rgb(77, 117, 124)";
                    ctx.strokeStyle = "rgb(77, 117, 124)";
                    ctx.globalAlpha = 1;
                    ctx.strokeText("#"+_x+_y, 5, _img.height/_rows - 5);
                    ctx.globalAlpha = 1.0;
                }
            } else {
                ctx.fillStyle = '#000';
                ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);
            }
        }
    }
})();

var imageParts = [];
var clicks = 0;
var displayHelp = false;

function setImage(url, rows, columns) {
    var img = new Image;
    img.onload = function() {   
        for(var i = 0; i < rows; ++i) {
            for(var j = 0; j < columns; ++j) {
                var ctx = $('#'+i+j)[0].getContext('2d');
                var imgPart;
                ctx.canvas.height = img.height/rows; 
                ctx.canvas.width = img.width/columns;

                if(i == rows - 1 && j == columns - 1) 
                    imgPart = new imagePart(j,i,rows,columns,img,true);
                else 
                    imgPart = new imagePart(j,i,rows,columns,img,false);

                imgPart.refresh();
                imageParts.push(imgPart);
            }
        }
    };  
    img.src = url;
}

function createTable(rows,columns) {
    $('#canvasTable').remove();
    var table = $('<table></table>')
        .attr({
            id : 'canvasTable',
            border : 0,
            cellspacing : 0,
            cellpadding : 0
        });
    for(var i = 0; i < rows; ++i) {
        var tr = $('<tr></tr>');
        for(var j = 0; j < columns; ++j) {
            var td = $('<td></td>')
                .append($('<canvas></canvas>')
                        .addClass('imagePart')
                        .attr({id : ''+i+j}))
                .addClass('tableCell');
            $(tr).append(td);
        }
        $(table).append(tr);
    }
    $('#puzzle').append(table);
}

function getImgPart(x,y) {
    for(var i in imageParts) {
        if(imageParts[i].posX() == x && imageParts[i].posY() == y) {
            return imageParts[i];
        }
    }
}

function getImgPartById(id) {
    for(var i in imageParts) {
        if(imageParts[i].id() == '#' + id) {
            return imageParts[i];
        }
    }
}

function switchParts(x1, y1, x2, y2) {
    var imgPart1 = getImgPart(x1,y1);
    var imgPart2 = getImgPart(x2,y2);

    if(imgPart1 !== imgPart2) {
        imgPart1.changePosition(x2,y2);
        imgPart2.changePosition(x1,y1);
    }
}

function clickOn(id) {
    var imgPart = getImgPartById(id);
    var special;

    for(var i in imageParts) {
        if(imageParts[i].special()) 
            special = imageParts[i];
    }

    if(special === imgPart) 
        return false;

    if(special.posX() == imgPart.posX() || special.posY() == imgPart.posY()) {
        var diffX = special.posX() - imgPart.posX();
        var diffY = special.posY() - imgPart.posY();
        var signX = diffX < 0 ? -1 : 1;
        var signY = diffY < 0 ? -1 : 1;
      
        for(var i = 0; i < Math.max(Math.abs(diffX), Math.abs(diffY)); ++i) {
            switchParts(special.posX(), special.posY(), 
                    diffX != 0 ? special.posX() - signX : special.posX(), 
                    diffY != 0 ? special.posY() - signY : special.posY());
        }
        return true;
    }   
    return false;
}

function randomize(rows, columns, iteration) {
     i = 0;
     interval = setInterval(function() {
         var rand1 = Math.floor(Math.random() * rows);
         var rand2 = Math.floor(Math.random() * columns);
         if(clickOn("" + rand1 + rand2)) i++;
         if(iteration == i) clearInterval(interval);
     }, 7);
}

function setClicks(clicks_) {
    clicks = clicks_;
    $('#clicks').text(clicks);
}

function load(rows, columns, url) {
    if(url == "" || rows == 0 || columns == 0)
        return;

    imageParts = [];
    createTable(rows,columns);
    setImage(url, rows, columns);

    $('.imagePart').click( function() {
        if(clickOn(this.id)) {
            setClicks(clicks+1);
            if(checkWin(rows, columns)) {
                alert('done right');
                setClicks(0);
            }
        }
    });
}

function checkWin(rows, columns) {
    var win = true;
    for(var obj in imageParts) {
        win &= imageParts[obj].onDatPlace();
    }
    return win;
}

$(document).ready(function() {
    var rows = 4, columns = 4;
    load(rows,columns,"imgs/slider.png");
    randomize(rows, columns, 100);

    $('#displayHelp').change( function() {
        displayHelp = !displayHelp;
        for(var i in imageParts) {
            imageParts[i].refresh();
        }
    });
  
    $('#randomize').click( function() {
        setClicks(0);
        randomize(rows, columns, 100);
    });
});
</script>
	
	<style>
	table {
    font-size:20px;
    margin: 5px auto;
}

input, button{
    background-color: #000;
    color: #FFF;
    border:none;
    font-size:13px;
    padding: 1em;
    margin: 1em;
}

#clicks {
   font-size: 50px;
}

.imagePart {
    color: #292927;
    border-style: solid;
    border-width: 0.08em;
    margin: -3px -2px;
}
</style>
	
</html>